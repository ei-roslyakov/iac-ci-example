name: iac-ci

on:
  pull_request:

env:
  TF_VERSION        : "1.2.7"
  TG_VERSION        : "v0.38.7"
  AWS_REGION        : "us-east-2"
  AWS_ROLE_TO_ASSUME: "arn:aws:iam::948691256895:role/gh-action"
  S3_BACKET_NAME    : "rei-tf-state-s3"
  S3_BACKET_KEY     : "pull-request"

jobs:
  get_changed_folder:
    runs-on: ubuntu-latest
    outputs:
      dir: ${{ steps.get_folder.outputs.dirs }}
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: '0'
      
      - name: Run changed-files with dir_names
        id: changed-files-dir-names
        uses: tj-actions/changed-files@v25
        with:
          dir_names: "true"
          json: "true"

      - uses: actions/setup-python@v2
      - name: get_data_to_invoke_plan
        id: get_folder
        working-directory: ".github"
        run: |
          echo "::set-output name=dirs::$(python ./get_changed_folder.py --folders=${{ steps.changed-files-dir-names.outputs.modified_files }})"

  plan:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: write
    continue-on-error: false
    needs: [get_changed_folder]
    strategy:
      matrix:
        dir: ${{fromJSON(needs.get_changed_folder.outputs.dir)}}
    steps:
      - name: Checkout
        uses: actions/checkout@v2
   
      - name: Install tf and tg
        uses: ./.github/actions/install-tf-tg
        with:
          tf_version: ${{ env.TF_VERSION }}
          tg_version: ${{ env.TG_VERSION }}

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@master
        with:
          aws-region: ${{ env.AWS_REGION }}
          role-to-assume: ${{ env.AWS_ROLE_TO_ASSUME }}
          role-session-name: GithubActionsSession

      - uses: shimataro/ssh-key-action@v2
        with:
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          name: id_ed25519
          known_hosts: ${{ secrets.KNOWN_HOSTS_OF_GITHUB }}

      - name: Init
        working-directory: ${{ matrix.dir }}
        run: |
          terragrunt run-all init
      
      - name: Plan
        working-directory: ${{ matrix.dir }}
        run: |
          terragrunt run-all plan -out=tfplan.file

      - name: Upload data with plan
        working-directory: ${{ matrix.dir }}
        run: |
          ref_without_space=$(echo ${{ matrix.dir }} | sed 's/\ /-/g')
          zip -q -r data-with-plan.zip .
          aws s3 cp data-with-plan.zip s3://${{ env.S3_BACKET_NAME }}/${{ env.S3_BACKET_KEY }}/$ref_without_space/${{ github.head_ref }}/data-with-plan.zip --quiet
 
  apply:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: write
    continue-on-error: false
    needs: [get_changed_folder, plan]
    environment: 'apply-infra'
    strategy:
      max-parallel: 1
      matrix:
        dir: ${{fromJSON(needs.get_changed_folder.outputs.dir)}}
    steps:
      - name: Checkout
        uses: actions/checkout@v2

      - name: Install tf and tg
        uses: ./.github/actions/install-tf-tg
        with:
          tf_version: ${{ env.TF_VERSION }}
          tg_version: ${{ env.TG_VERSION }}

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@master
        with:
          aws-region: ${{ env.AWS_REGION }}
          role-to-assume: ${{ env.AWS_ROLE_TO_ASSUME }}
          role-session-name: GithubActionsSession
      
      - uses: shimataro/ssh-key-action@v2
        with:
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          name: id_ed25519
          known_hosts: ${{ secrets.KNOWN_HOSTS_OF_GITHUB }}
      
      - name: Get plan
        working-directory: ${{ matrix.dir }}
        run: |
          ref_without_space=$(echo ${{ matrix.dir }} | sed 's/\ /-/g')
          aws s3 cp s3://${{ env.S3_BACKET_NAME }}/${{ env.S3_BACKET_KEY }}/$ref_without_space/${{ github.head_ref }}/data-with-plan.zip data-with-plan.zip --quiet
          unzip -q -u data-with-plan.zip
      
      - name: Apply infra
        working-directory: ${{ matrix.dir }}
        run: |
          echo "Y" | terragrunt run-all apply tfplan.file
